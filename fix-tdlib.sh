#!/bin/bash

echo "üîß –£—Ç–∏–ª–∏—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å TDLib"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É
OS=$(uname -s)
if [ "$OS" = "Darwin" ]; then
    echo "üì± –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: macOS"
    LIB_EXT="dylib"
    SYSTEM_LIB_PATH="/usr/local/lib/libtdjson.dylib"
elif [ "$OS" = "Linux" ]; then
    echo "üêß –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: Linux"
    LIB_EXT="so"
    SYSTEM_LIB_PATH="/usr/local/lib/libtdjson.so"
else
    echo "‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: $OS"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ TDLib –≤ —Å–∏—Å—Ç–µ–º–µ
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ TDLib –≤ —Å–∏—Å—Ç–µ–º–µ..."
if [ -f "$SYSTEM_LIB_PATH" ]; then
    echo "‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ TDLib –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ: $SYSTEM_LIB_PATH"
else
    echo "‚ö†Ô∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ TDLib –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ"
    echo "üîÑ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TDLib..."
    
    if [ "$OS" = "Darwin" ]; then
        ./install-tdlib-macos.sh
    elif [ "$OS" = "Linux" ]; then
        ./install-tdlib-linux.sh
    fi
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é lib, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ lib..."
mkdir -p lib

# –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ lib
echo "üîó –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫..."
if [ "$OS" = "Darwin" ]; then
    ln -sf "$SYSTEM_LIB_PATH" lib/libtdjson.dylib
    echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ lib/libtdjson.dylib -> $SYSTEM_LIB_PATH"
elif [ "$OS" = "Linux" ]; then
    ln -sf "$SYSTEM_LIB_PATH" lib/libtdjson.so
    echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ lib/libtdjson.so -> $SYSTEM_LIB_PATH"
    
    # –°–æ–∑–¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å macOS
    ln -sf "$SYSTEM_LIB_PATH" lib/libtdjson.dylib
    echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ lib/libtdjson.dylib -> $SYSTEM_LIB_PATH (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —Å–µ—Å—Å–∏–π
echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —Å–µ—Å—Å–∏–π..."
mkdir -p sessions
mkdir -p telegram-session

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "üîí –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
chmod 700 sessions
chmod 700 telegram-session

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ .env
echo "üìÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ .env..."
if [ ! -f ".env" ]; then
    echo "‚ö†Ô∏è –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω..."
    cat > .env << EOF
PORT=3000
NODE_ENV=development
SESSION_SECRET=giftex-secret-key

# Telegram API (–ø–æ–ª—É—á–∏—Ç–µ –Ω–∞ https://my.telegram.org/apps)
TELEGRAM_API_ID=
TELEGRAM_API_HASH=

# –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin
EOF
    echo "‚úÖ –°–æ–∑–¥–∞–Ω —à–∞–±–ª–æ–Ω —Ñ–∞–π–ª–∞ .env. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏."
else
    echo "‚úÖ –§–∞–π–ª .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ npm
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π npm..."
npm list tdl tdl-tdlib-addon > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª–∏"
    echo "üîÑ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    npm install tdl@7.3.0 --save
else
    echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–∫–µ"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç TDLib
echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ TDLib..."
node test-tdlib.js

# –í—ã–≤–æ–¥–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
echo ""
echo "üéØ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:"
echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ —Ñ–∞–π–ª–µ .env —É–∫–∞–∑–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ TELEGRAM_API_ID –∏ TELEGRAM_API_HASH"
echo "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é –æ–¥–Ω–æ–π –∏–∑ –∫–æ–º–∞–Ω–¥:"
echo "   - npm run dev (—Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)"
echo "   - ./start-server.sh (–æ–±—ã—á–Ω—ã–π –∑–∞–ø—É—Å–∫)"
echo "   - ./pm2-start.sh (–∑–∞–ø—É—Å–∫ —Å PM2)"
echo ""
echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å TDLib –∑–∞–≤–µ—Ä—à–µ–Ω–æ" 