#!/bin/bash

echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° GIFTEX Ð´Ð»Ñ Linux"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚
echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚..."
command -v node >/dev/null 2>&1 || { echo "âŒ Node.js Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð¿ÐµÑ€ÐµÐ´ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸ÐµÐ¼."; exit 1; }
command -v npm >/dev/null 2>&1 || { echo "âŒ npm Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð¿ÐµÑ€ÐµÐ´ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸ÐµÐ¼."; exit 1; }

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
npm install

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
mkdir -p lib
mkdir -p sessions
mkdir -p telegram-session

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ TDLib
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ TDLib..."
if [ -f "/usr/local/lib/libtdjson.so" ]; then
    echo "âœ… Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° TDLib Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ: /usr/local/lib/libtdjson.so"
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÑƒÑŽ ÑÑÑ‹Ð»ÐºÑƒ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
    ln -sf /usr/local/lib/libtdjson.so lib/libtdjson.so
    ln -sf /usr/local/lib/libtdjson.so lib/libtdjson.dylib
    echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ñ‹ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÑÑ‹Ð»ÐºÐ¸ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ lib/"
else
    echo "âš ï¸ Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° TDLib Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ."
    echo "ðŸ”„ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° TDLib..."
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
    echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸..."
    sudo apt-get update
    sudo apt-get install -y build-essential cmake gperf libssl-dev zlib1g-dev
    
    # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ TDLib
    echo "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ TDLib..."
    git clone https://github.com/tdlib/td
    cd td
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
    mkdir -p build
    cd build
    
    # ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ TDLib
    echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° TDLib (ÑÑ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ)..."
    cmake -DCMAKE_BUILD_TYPE=Release ..
    cmake --build . --target install
    cd ../..
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÑÑ‹Ð»ÐºÐ¸
    ln -sf /usr/local/lib/libtdjson.so lib/libtdjson.so
    ln -sf /usr/local/lib/libtdjson.so lib/libtdjson.dylib
    echo "âœ… TDLib ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
fi

# ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼ CSS
echo "ðŸŽ¨ ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ CSS..."
npm run build:css

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° .env
if [ ! -f ".env" ]; then
    echo "âš ï¸ Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑˆÐ°Ð±Ð»Ð¾Ð½..."
    cat > .env << EOF
PORT=3000
NODE_ENV=development
SESSION_SECRET=giftex-secret-key

# Telegram API (Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð½Ð° https://my.telegram.org/apps)
TELEGRAM_API_ID=
TELEGRAM_API_HASH=

# Ð£Ñ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin
EOF
    echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½ ÑˆÐ°Ð±Ð»Ð¾Ð½ Ñ„Ð°Ð¹Ð»Ð° .env. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ ÑÐ²Ð¾Ð¸Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸."
else
    echo "âœ… Ð¤Ð°Ð¹Ð» .env ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
fi

echo "ðŸŽ‰ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°! Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚:"
echo "   npm run dev    - Ð´Ð»Ñ Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸"
echo "   ./start-server.sh - Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ€ÐµÐ¶Ð¸Ð¼Ð°"

# Ð”ÐµÐ»Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼Ð¸
chmod +x start-server.sh
chmod +x install-tdlib-linux.sh

echo "ðŸ” ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒÑ‚Ðµ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ TELEGRAM_API_ID Ð¸ TELEGRAM_API_HASH Ð² Ñ„Ð°Ð¹Ð»Ðµ .env" 